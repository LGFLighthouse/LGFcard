<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapbox GL â€“ Enhanced Multi-Marker Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    .custom-marker {
      background-size: cover;
      background-position: center;
      border-radius: 50%;
    }

    .mapboxgl-popup-content {
      font-size: 13px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidnhsZ2ZjIiwiYSI6ImNsd3lueXhidzFld2IybnF6Y2J3b3ptbzgifQ.eGHB2Tuu-dJPHF93HzLMdA';

    function getMarkersFromURL() {
      try {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('markers');
        if (!raw) return [];
        return JSON.parse(decodeURIComponent(raw));
      } catch (e) {
        console.error("Invalid marker JSON:", e);
        return [];
      }
    }

    const markers = getMarkersFromURL();
    const defaultCenter = [7.438909, 46.943856];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/vxlgfc/cmcaly08900o401sh6xr5abc8',
      center: defaultCenter,
      zoom: 14,
      pitch: 46.08,     // tilt for 3D perspective
      bearing: -69.49,  // slight rotation for aesthetic angle
      antialias: true  // improves 3D rendering quality (optional but recommended)
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Add satellite/street toggle
    const toggleControl = {
      onAdd: function(map) {
        const btn = document.createElement('button');
        btn.textContent = 'ðŸ—º Toggle Style';
        btn.style.padding = '6px';
        btn.style.margin = '10px';
        btn.style.background = '#fff';
        btn.style.border = '1px solid #ccc';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
          const current = map.getStyle().name || '';
          const nextStyle = map.getStyle().sprite.includes('clwyo9kv') ?
            'mapbox://styles/mapbox/satellite-streets-v12' :
            'mapbox://styles/vxlgfc/clwyo9kv301hz01r0dyn45uz0';
          map.setStyle(nextStyle);
        };
        const container = document.createElement('div');
        container.appendChild(btn);
        return container;
      },
      onRemove: function() {}
    };
    map.addControl(toggleControl, 'top-left');

    const bounds = new mapboxgl.LngLatBounds();

    markers.forEach(marker => {
      if (!marker.lat || !marker.lon) return;

      const iconURL = marker.icon || 'https://cdn-icons-png.flaticon.com/512/149/149060.png';
      const width = marker.iconWidth || 32;
      const height = marker.iconHeight || 32;
      const label = marker.label || `(${marker.lat.toFixed(4)}, ${marker.lon.toFixed(4)})`;

      const el = document.createElement('div');
      el.className = 'custom-marker';
      el.style.width = width + 'px';
      el.style.height = height + 'px';
      el.style.backgroundImage = `url(${iconURL})`;

      const m = new mapboxgl.Marker(el).setLngLat([marker.lon, marker.lat]).addTo(map);

      const popup = new mapboxgl.Popup({
        offset: [0, -height * 0.6],
        closeButton: false,
        closeOnClick: false
      }).setText(label);

      m.setPopup(popup);
      popup.addTo(map);

      bounds.extend([marker.lon, marker.lat]);
    });

    // Fit to markers
    if (markers.length > 1) {
      map.fitBounds(bounds, { padding: 40, maxZoom: 18 });
    } else if (markers.length === 1) {
      map.setCenter([markers[0].lon, markers[0].lat]);
      map.setZoom(18);
    }
  </script>
</body>
</html>
