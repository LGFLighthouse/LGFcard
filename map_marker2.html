<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapbox GL â€“ Marker Clustering</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <script src="https://cdn.jsdelivr.net/npm/mapbox-gl@3.13.0/dist/mapbox-gl.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@3.13.0/dist/mapbox-gl.min.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .custom-marker {
      border-radius: 50%;
      object-fit: cover;
    }
    #toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="toast">Copied to clipboard</div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidnhsZ2ZjIiwiYSI6ImNsd3lueXhidzFld2IybnF6Y2J3b3ptbzgifQ.eGHB2Tuu-dJPHF93HzLMdA';

    const params = new URLSearchParams(window.location.search);
    const raw = params.get("markers");
    const markerData = raw ? JSON.parse(decodeURIComponent(raw)) : [];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/vxlgfc/cmcaly08900o401sh6xr5abc8',
      center: [7.438909, 46.943856],
      zoom: 16.5,
      pitch: 32,
      bearing: -46,
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const bounds = new mapboxgl.LngLatBounds();
    const geojson = {
      type: "FeatureCollection",
      features: markerData.map((m, idx) => ({
        type: "Feature",
        geometry: { type: "Point", coordinates: [m.lon, m.lat] },
        properties: {
          id: idx,
          label: m.label || `(${m.lat}, ${m.lon})`,
          icon: m.icon || '',
          iconWidth: m.iconWidth || 32,
          iconHeight: m.iconHeight || 32
        }
      }))
    };

    map.on('load', () => {

      // Style toggle control
      const toggleControl = {
        onAdd: function (map) {
          const container = document.createElement('div');
          container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group print-hide';
          const button = document.createElement('button');
          button.innerHTML = 'ðŸ—º';
          button.title = 'Toggle Style';
          button.onclick = () => {
            const style = map.getStyle().sprite || '';
            const usingStyleA = style.includes('cmcaly08900o401sh6xr5abc8');
            map.setStyle(usingStyleA
              ? 'mapbox://styles/vxlgfc/cmcb14up800vd01sh9nasfukj'
              : 'mapbox://styles/vxlgfc/cmcaly08900o401sh6xr5abc8');
          };
          container.appendChild(button);
          return container;
        },
        onRemove: function () {}
      };
      map.addControl(toggleControl, 'top-left');


      // Right-click to copy coordinates
      map.on('contextmenu', (e) => {
        const lat = e.lngLat.lat.toFixed(6);
        const lon = e.lngLat.lng.toFixed(6);
        const coordText = `${lat}, ${lon}`;
        new mapboxgl.Popup({ closeOnClick: true, offset: 10 })
          .setLngLat(e.lngLat)
          .setHTML(`<strong>Coordinates:</strong><br><code style='cursor:pointer' onclick='copyToClipboard("${coordText}")'>${coordText}</code>`)
          .addTo(map);
      });

      window.copyToClipboard = function (text) {
        navigator.clipboard.writeText(text).then(() => {
          const toast = document.getElementById('toast');
          toast.style.display = 'block';
          setTimeout(() => toast.style.display = 'none', 1500);
        });
      };


      map.addSource('markers', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 18,
        clusterRadius: 50
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'markers',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#51bbd6',
          'circle-radius': ['step', ['get', 'point_count'], 20, 5, 30, 10, 40],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#fff'
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'markers',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['Open Sans Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'symbol',
        source: 'markers',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'icon-image': ['concat', 'marker-15'],
          'icon-size': 1,
          'text-field': ['get', 'label'],
          'text-font': ['Open Sans Regular'],
          'text-offset': [0, 1.2],
          'text-anchor': 'top'
        }
      });

      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('markers').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom
          });
        });
      });

      map.on('click', 'unclustered-point', (e) => {
        const props = e.features[0].properties;
        const coords = e.features[0].geometry.coordinates.slice();
        const popup = new mapboxgl.Popup({
          offset: [0, -parseInt(props.iconHeight || '32')],
          anchor: 'bottom',
          closeButton: false,
          closeOnClick: false
        }).setLngLat(coords).setText(props.label).addTo(map);
      });

      if (markerData.length > 1) {
        markerData.forEach(m => bounds.extend([m.lon, m.lat]));
        map.fitBounds(bounds, { padding: 40, maxZoom: 18 });
      }
    });
  </script>
</body>
</html>
